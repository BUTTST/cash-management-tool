<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…· v1_5/2</title>
    <style>
        /* --- åŸºæœ¬æ¨£å¼å’Œè®Šæ•¸ --- */
        :root {
            --primary: #0d47a1; /* ä¸»è‰² */
            --primary-light: #1a73e8; /* ä¸»äº®è‰² */
            --secondary: #34a853; /* æ¬¡è¦è‰² (ç¶ ) */
            --tertiary: #fbbc05; /* ç¬¬ä¸‰è‰² (é»ƒ) */
            --danger: #ea4335; /* å±éšª/éŒ¯èª¤è‰² (ç´…) */
            --warning: #ff9800; /* è­¦å‘Šè‰² (æ©˜) */
            --light: #f8f9fa; /* æ·ºè‰²èƒŒæ™¯ */
            --dark: #202124; /* æ·±è‰²æ–‡å­— */
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* é™°å½± */
            --radius: 8px; /* åœ“è§’ */
            /* é¢é¡é¡è‰² */
            --note-1000: #9c27b0; /* ç´« */
            --note-500: #ff9800; /* æ©˜ */
            --note-100: #3f51b5; /* è— */
            --coin-50: #607d8b; /* ç°è— */
            --coin-10: #4caf50; /* ç¶  */
            --coin-5: #795548; /* æ£• */
            --coin-1: #9e9e9e; /* ç° */
            --success: #28a745; /* æˆåŠŸè‰² (ç¶ ) */
            --gray: #6c757d; /* ç°è‰² */
        }
        * {box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;}
        body {background-color: #f0f2f5; color: var(--dark); line-height: 1.6;}
        .container {max-width: 960px; margin: 0 auto; padding: 0 1rem;}
        .header {text-align: center; margin: 1rem 0; color: var(--primary);}
        .header h1 {margin-bottom: 0.5rem;}
        .card {background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.2rem; margin-bottom: 1.2rem; border-top: 4px solid var(--primary);}
        .input-section {margin-bottom: 0.8rem;}
        .section-title {color: var(--primary); margin-bottom: 0.8rem; padding-bottom: 0.4rem; border-bottom: 2px solid var(--tertiary); font-size: 1.4rem; font-weight: 700;}
        .subsection-title {color: var(--secondary); margin-top: 1rem; margin-bottom: 0.6rem; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;}
        .subsection-title:before {content: ""; display: inline-block; width: 6px; height: 18px; background-color: var(--secondary); margin-right: 8px; border-radius: 3px;}
        .input-form {display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem;}
        .input-group {margin-bottom: 0.8rem; position: relative;}
        .input-group label {display: block; margin-bottom: 0.4rem; font-weight: 600;}
        .input-flexbox {display: flex; gap: 0.5rem;}
        .bag-input {width: 15%; padding: 0.7rem 0.5rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem; text-align: center; background-color: #f0f0f0;}
        .amount-input {width: 85%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1.1rem; transition: all 0.3s; background-color: #f9f9f9;}
        .input-group input:focus, .input-group select:focus {border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); background-color: white;}
        .input-error {border-color: var(--danger) !important; animation: pulse-error 1.5s infinite;}
        .error-message {color: var(--danger); font-size: 0.8rem; margin-top: 0.3rem; display: none;}
        .error-message.active {display: block; animation: fadeIn 0.3s;}
        .balance-error {animation: pulse-error 1.5s infinite;}
        .btn {background-color: var(--primary-light); color: white; border: none; border-radius: var(--radius); padding: 0.75rem 1.5rem; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; display: inline-block; text-align: center; font-weight: 600; letter-spacing: 0.5px;}
        .btn:hover {background-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);}
        .btn:active {transform: translateY(0);}
        .btn-block {display: block; width: 100%;}
        .btn-clear {background-color: #6c757d; margin-bottom: 0.5rem;}
        .btn-clear:hover {background-color: #5a6268;}
        .btn-simulate {background-color: #28a745; margin-bottom: 1rem;}
        .btn-simulate:hover {background-color: #218838;}
        .btn-confirm {background-color: var(--primary-light); width: 100%;}
        .buttons-row {display: flex; gap: 0.5rem; margin-bottom: 1rem;}
        .buttons-row .btn {flex: 1;}
        .result-section {display: none;}
        .result-section.active {display: block; animation: fadeIn 0.5s;}
        @keyframes fadeIn {from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
        @keyframes pulse-error {0% {box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(234, 67, 53, 0);} 100% {box-shadow: 0 0 0 0 rgba(234, 67, 53, 0);}}
        .result-block {background-color: #f9f9f9; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--tertiary); transition: all 0.3s;}
        .result-block:hover {box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);}
        .result-block-notes {border-left-color: var(--note-100);}
        .result-block-coins {border-left-color: var(--coin-10);}
        .warning-block {background-color: #fff3e0; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--warning); position: relative; overflow: hidden;}
        .warning-block:after {content: "âš ï¸"; position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.2;}
        .warning-title {color: var(--warning); font-weight: bold; margin-bottom: 0.6rem; font-size: 1.1rem; display: flex; align-items: center;}
        .warning-title:before {content: "âš ï¸"; margin-right: 6px;}
        .info-block {background-color: #e3f2fd; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--primary-light); position: relative;}
        .info-block:after {content: "â„¹ï¸"; position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.2;}
        .info-title {color: var(--primary); font-weight: bold; margin-bottom: 0.6rem; font-size: 1.1rem; display: flex; align-items: center;}
        .info-title:before {content: "â„¹ï¸"; margin-right: 6px;}
        .result-row {display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; padding-bottom: 0.6rem; border-bottom: 1px dashed #e0e0e0; line-height: 1.4;}
        .result-row:last-child {border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
        .result-row .label {flex: 1; font-weight: 500;}
        .result-row .value {text-align: right; font-weight: 600; min-width: 160px;}
        .result-total {font-weight: bold; font-size: 1.15rem; color: var(--primary); border-top: 2px solid var(--tertiary); padding-top: 0.6rem; margin-top: 0.6rem;}
        .result-total .note {font-size: 0.8rem; color: #666; font-weight: normal; display: block; margin-top: 0.2rem;}
        .coin-detail {font-size: 0.95rem; color: #555; margin-top: 0.6rem; padding: 0.6rem; border-radius: var(--radius); background-color: #efefef; border-left: 3px solid #bbb;}
        .highlight {display: inline-block; background-color: #fff9e0; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; margin: 0.2rem 0; border: 1px solid #ffe082;}
        .denomination {display: flex; align-items: center; margin-bottom: 6px;}
        .denom-icon {width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-right: 10px; border-radius: 50%; font-weight: bold; color: white; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        .note-1000 {background-color: var(--note-1000);}
        .note-500 {background-color: var(--note-500);}
        .note-100 {background-color: var(--note-100);}
        .coin-50 {background-color: var(--coin-50);}
        .coin-10 {background-color: var(--coin-10);}
        .coin-5 {background-color: var(--coin-5);}
        .coin-1 {background-color: var(--coin-1);}
        .money-amount {font-size: 1.2rem; font-weight: 700; color: var(--primary);}
        .money-amount-1000 {color: var(--note-1000);}
        .money-amount-500 {color: var(--note-500);}
        .money-amount-100 {color: var(--note-100);}
        .money-amount-50 {color: var(--coin-50);}
        .money-amount-10 {color: var(--coin-10);}
        .money-amount-5 {color: var(--coin-5);}
        .money-amount-1 {color: var(--coin-1);}
        .money-count {background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 600; font-size: 0.9rem; margin-left: 6px; border: 1px solid #ddd;}
        .money-package {background-color: #e8f5e9; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 600; font-size: 0.9rem; margin-left: 6px; border: 1px solid #c8e6c9; white-space: nowrap;}
        .summary-box {display: flex; flex-direction: column; background-color: #e8f0fe; border-radius: var(--radius); padding: 0.8rem; margin-bottom: 0.8rem; border: 1px solid #c0d6f9; transition: all 0.3s;}
        .summary-box.error {background-color: #ffebee; border-color: #ffcdd2; animation: pulse-error 1.5s infinite;}
        .summary-title {font-weight: 600; margin-bottom: 0.4rem; color: var(--primary); font-size: 1rem;}
        .summary-value {font-size: 1.4rem; font-weight: 700; color: var(--primary); align-self: flex-end;}
        .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem;}
        .compact-card {padding-top: 0.8rem; padding-bottom: 0.8rem;}
        .compact-block {padding: 0.8rem; margin-bottom: 0.8rem;}
        .compact-row {margin-bottom: 0.4rem; padding-bottom: 0.4rem;}
        .collapsible-header {cursor: pointer; display: flex; justify-content: space-between; align-items: center;}
        .collapsible-header:after {content: "â–¼"; font-size: 0.8rem; transition: transform 0.3s;}
        .collapsible-header.collapsed:after {transform: rotate(-90deg);}
        .collapsible-content {overflow: hidden; max-height: 1000px; transition: max-height 0.3s ease-in-out;}
        .collapsible-content.collapsed {max-height: 0;}

        /* --- ä»£æ”¶PCè¨ˆç®—å€å¡Š --- */
        .extra-calc {margin-top: 1rem;}
        .extra-calc-header {display: flex; align-items: center; background-color: var(--primary-light); color: white; padding: 0.8rem; border-radius: var(--radius) var(--radius) 0 0; font-weight: 600; cursor: pointer; justify-content: space-between;}
        .extra-calc-header-title {display: flex; align-items: center;}
        .extra-calc-header-icon {margin-left: 0.5rem; font-size: 0.8rem; transition: transform 0.3s;}
        .extra-calc-header-icon.collapsed {transform: rotate(-90deg);}
        .extra-calc-container {background-color: #f8f9fa; padding: 1rem; border-radius: 0 0 var(--radius) var(--radius); border: 1px solid #e9ecef; border-top: none; overflow: hidden; max-height: 1000px; transition: max-height 0.3s ease-in-out;}
        .extra-calc-container.collapsed {max-height: 0; padding: 0; border: 0;}
        .extra-calc-row {display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;}
        .extra-calc-col {flex: 1; min-width: 0;}
        .extra-calc-col label {display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--dark);}
        .extra-calc-input {width: 100%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem;}
        .extra-calc-input:disabled {background-color: #e9ecef; color: var(--gray);}
        .extra-calc-result {text-align: center; padding: 0.8rem; background-color: #e8f5e9; border-radius: var(--radius); font-weight: bold; color: var(--success); font-size: 1.2rem; margin-top: 0.5rem;}
        .lock-btn {background-color: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: var(--radius); margin-left: 1rem; transition: all 0.3s;}
        .lock-btn:hover {background-color: rgba(255, 255, 255, 0.2);}
        .lock-btn.locked {color: var(--warning);}

        /* --- æ¨¡æ…‹æ¡†é€šç”¨æ¨£å¼ --- */
        .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);}
        .modal-content {background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: var(--radius); box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideDown 0.4s; overflow: hidden;}
        @keyframes slideDown {from {opacity: 0; transform: translateY(-30px);} to {opacity: 1; transform: translateY(0);}}
        .modal-header {background-color: var(--primary-light); color: white; padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center;}
        .modal-header h3 {margin: 0; font-size: 1.2rem;}
        .close {color: white; font-size: 24px; font-weight: bold; cursor: pointer; opacity: 0.8; line-height: 1;}
        .close:hover {opacity: 1;}
        .modal-body {padding: 1rem;}
        .manual-section h4 { margin-top: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
        .manual-section p, .manual-section ul { margin-bottom: 0.8rem; }
        .manual-section ul { padding-left: 20px; }
        .table-container { overflow-x: auto; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }

        /* --- é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ç‰¹å®šæ¨£å¼ --- */
        .exchange-section {margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;}
        .exchange-section:last-child {border-bottom: none; margin-bottom: 0;}
        .exchange-section h4 {margin: 0 0 0.8rem; color: var(--primary);}
        .exchange-field {margin-bottom: 1rem;}
        .exchange-field label {display: block; margin-bottom: 0.4rem; font-weight: 600;}
        .exchange-input { /* å°‡ .amount-input æ”¹ç‚º .exchange-input ä»¥é¿å…è¡çª */
            width: 100%; /* èª¿æ•´å¯¬åº¦ */
            padding: 0.7rem;
            border: 2px solid #ddd;
            border-radius: var(--radius);
            font-size: 1.1rem;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        .exchange-input:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            background-color: white;
        }
        .exchange-select {width: 100%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem; background-color: #f9f9f9;}
        .exchange-info {background-color: #e8f0fe; padding: 1rem; border-radius: var(--radius); margin-top: 1rem;}
        .exchange-info div {margin-bottom: 0.4rem; line-height: 1.5;}
        .exchange-arrow {display: flex; justify-content: center; margin: 1rem 0; color: var(--primary); font-size: 2rem;}
        .btn-exchange {background-color: var(--primary-light); width: 100%; padding: 0.8rem; font-size: 1.2rem;}

        /* --- é ‚éƒ¨æŒ‰éˆ• --- */
        .info-btn {background-color: var(--primary-light); color: white; border: none; border-radius: var(--radius); padding: 0.4rem 0.8rem; margin: 0.4rem; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; display: inline-block; text-align: center; font-weight: 600;}
        .info-btn:hover {background-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);}
        .action-buttons {display: flex; justify-content: center; gap: 8px; margin: 12px 0 8px; flex-wrap: wrap;}

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
        @media (max-width: 768px) {
            .input-form {grid-template-columns: 1fr; gap: 0.5rem;}
            .result-row {flex-direction: column; align-items: flex-start;} /* èª¿æ•´å°é½Š */
            .result-row .value {text-align: left; margin-top: 3px; margin-left: 0px;} /* ç§»é™¤å·¦é‚Šè· */
            .summary-grid {grid-template-columns: 1fr; gap: 0.5rem;}
            .modal-content {width: 95%; margin: 20px auto;}
            .action-buttons {flex-direction: row; gap: 4px;} /* æ”¹å›æ©«å‘æ’åˆ— */
            .info-btn {margin: 0.2rem;}
            .card {padding: 1rem; margin-bottom: 1rem;}
            .section-title {font-size: 1.3rem;}
            .subsection-title {font-size: 1.1rem;}
            .money-amount {font-size: 1.1rem;}
            .summary-value {font-size: 1.3rem;}
            .extra-calc-row {flex-direction: column; gap: 0.5rem;}
            .extra-calc-col {width: 100%;}
            .input-flexbox { flex-direction: row; } /* ç¢ºä¿è¢‹/æ†è¼¸å…¥æ¡†åœ¨å°è¢å¹•ä¹Ÿæ©«å‘ */
            .bag-input { width: 25%; } /* èª¿æ•´è¢‹/æ†è¼¸å…¥æ¡†å¯¬åº¦ */
            .amount-input { width: 75%; } /* èª¿æ•´é‡‘é¡è¼¸å…¥æ¡†å¯¬åº¦ */
        }
        @media (max-width: 480px) {
             .action-buttons {flex-direction: column; gap: 4px;} /* åœ¨æ›´å°è¢å¹•è®Šå›å‚ç›´ */
             .info-btn {width: 100%; margin: 0.2rem 0;}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…·</h1>
            <p>è¼¸å…¥å„é¢é¡ç¸½é‡‘é¡ï¼Œç³»çµ±è‡ªå‹•è¨ˆç®—é›¶éŒ¢è™•ç†ã€é ç•™é›¶ç”¨é‡‘å’Œç‡Ÿæ”¶ä¸Šç¹³</p>
            <div class="action-buttons">
                <button id="show-package-info" class="info-btn">ç¡¬å¹£&ç´™éˆ”åŒ…è£è³‡è¨Š</button>
                <button id="show-manual" class="info-btn">æŸ¥çœ‹ä½¿ç”¨èªªæ˜</button>
                <button id="show-exchange" class="info-btn">é¢é¡æ›ç®—å·¥å…·</button>
            </div>
        </div>

        <div class="card">
            <div class="input-section">
                <div class="buttons-row">
                    <button id="clear-btn" class="btn btn-clear">æ¸…é™¤æ•¸å€¼</button>
                    <button id="simulate-btn" class="btn btn-simulate">æ¨¡æ“¬æ•¸å€¼</button>
                </div>
                <h2 class="section-title">è¼¸å…¥å„é¢é¡ç¸½é‡‘é¡</h2>
                <div class="input-form">
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon note-1000">1K</div>
                            <label for="amount1000">1000 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <input type="text" id="amount1000" data-denomination="1000" placeholder="ä¾‹å¦‚: 8000" inputmode="numeric" class="amount-input">
                        <div id="error1000" class="error-message">è«‹è¼¸å…¥1000çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon note-500">500</div>
                            <label for="amount500">500 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <input type="text" id="amount500" data-denomination="500" placeholder="ä¾‹å¦‚: 13000" inputmode="numeric" class="amount-input">
                        <div id="error500" class="error-message">è«‹è¼¸å…¥500çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon note-100">100</div>
                            <label for="amount100">100 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <div class="input-flexbox">
                            <input type="text" id="bundle100" data-package-type="bundle" data-denomination="100" placeholder="æ†" inputmode="numeric" class="bag-input">
                            <input type="text" id="amount100" data-denomination="100" placeholder="ä¾‹å¦‚: 7200" inputmode="numeric" class="amount-input">
                        </div>
                        <div id="error100" class="error-message">è«‹è¼¸å…¥100çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon coin-50">50</div>
                            <label for="amount50">50 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <div class="input-flexbox">
                            <input type="text" id="bag50" data-package-type="bag" data-denomination="50" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                            <input type="text" id="amount50" data-denomination="50" placeholder="ä¾‹å¦‚: 1450" inputmode="numeric" class="amount-input">
                        </div>
                        <div id="error50" class="error-message">è«‹è¼¸å…¥50çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon coin-10">10</div>
                            <label for="amount10">10 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <div class="input-flexbox">
                            <input type="text" id="bag10" data-package-type="bag" data-denomination="10" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                            <input type="text" id="amount10" data-denomination="10" placeholder="ä¾‹å¦‚: 720" inputmode="numeric" class="amount-input">
                        </div>
                        <div id="error10" class="error-message">è«‹è¼¸å…¥10çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon coin-5">5</div>
                            <label for="amount5">5 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <div class="input-flexbox">
                            <input type="text" id="bag5" data-package-type="bag" data-denomination="5" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                            <input type="text" id="amount5" data-denomination="5" placeholder="ä¾‹å¦‚: 345" inputmode="numeric" class="amount-input">
                        </div>
                        <div id="error5" class="error-message">è«‹è¼¸å…¥5çš„å€æ•¸</div>
                    </div>
                    <div class="input-group">
                        <div class="denomination">
                            <div class="denom-icon coin-1">1</div>
                            <label for="amount1">1 å…ƒç¸½é‡‘é¡</label>
                        </div>
                        <div class="input-flexbox">
                            <input type="text" id="bag1" data-package-type="bag" data-denomination="1" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                            <input type="text" id="amount1" data-denomination="1" placeholder="ä¾‹å¦‚: 321" inputmode="numeric" class="amount-input">
                        </div>
                        <div id="error1" class="error-message">è«‹è¼¸å…¥æ­£æ•´æ•¸</div>
                    </div>
                </div>
                <button id="calculate-btn" class="btn btn-block">è¨ˆç®—çµæœ</button>

                <div class="extra-calc">
                    <div class="extra-calc-header">
                        <div class="extra-calc-header-title">
                            ä»£æ”¶(+) â€” PC(-) é¡å¤–è¨ˆç®—
                            <span class="extra-calc-header-icon">â–¼</span>
                        </div>
                        <button id="lock-btn" class="lock-btn" title="é–å®š/è§£é–è¼¸å…¥æ¡†">ğŸ”“</button>
                    </div>
                    <div class="extra-calc-container collapsed"> <div class="extra-calc-row">
                            <div class="extra-calc-col">
                                <label for="report-total">å ±è¡¨ç¸½é¡</label>
                                <input type="text" id="report-total" placeholder="è¼¸å…¥å ±è¡¨ç¸½é¡" class="extra-calc-input" inputmode="numeric">
                            </div>
                            <div class="extra-calc-col">
                                <label for="collect-amount">ä»£æ”¶ (+)</label>
                                <input type="text" id="collect-amount" placeholder="æ­¤æ ¼æ•¸å€¼æœƒåŠ ç¸½" class="extra-calc-input" inputmode="numeric">
                            </div>
                            <div class="extra-calc-col">
                                <label for="pc-amount">PC (-)</label>
                                <input type="text" id="pc-amount" placeholder="æ­¤æ ¼æ•¸å€¼æœƒæ¸›ç¸½" class="extra-calc-input" inputmode="numeric">
                            </div>
                        </div>
                        <div class="extra-calc-result" id="extra-calc-result">è¨ˆç®—çµæœï¼š0 å…ƒ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="result-container" class="result-section">
            <div class="card compact-card">
                <h2 class="section-title">çµæœç¸½è¦½</h2>
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="summary-title">å…¨éƒ¨ç¸½é‡‘é¡</div>
                        <div id="total-amount" class="summary-value">0 å…ƒ</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title">é›¶éŒ¢è™•ç†ï¼ˆç§»å…¥ç‡Ÿæ”¶ï¼‰</div>
                        <div id="summary-small-coins" class="summary-value">0 å…ƒ</div>
                    </div>
                    <div id="petty-cash-box" class="summary-box">
                        <div class="summary-title">é ç•™é›¶ç”¨é‡‘</div>
                        <div id="petty-cash-actual" class="summary-value">20,000 å…ƒ</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-title">ç‡Ÿæ”¶ä¸Šç¹³</div>
                        <div id="summary-revenue" class="summary-value">0 å…ƒ</div>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2 class="section-title collapsible-header collapsed">é›¶éŒ¢è™•ç† â†’ ç§»å…¥ã€Œç‡Ÿæ”¶ã€</h2>
                <div class="collapsible-content collapsed">
                    <div class="result-block compact-block result-block-coins">
                        <div class="result-row compact-row">
                            <div class="label">å››ç¨®ç¡¬å¹£åˆè¨ˆï¼ˆ50+10+5+1ï¼‰ï¼š</div>
                            <div id="total-coins" class="value money-amount">0 å…ƒ</div>
                        </div>
                        <div class="result-row compact-row">
                            <div class="label">å¤šå‡ºå…©ä½æ•¸ï¼ˆmod 100ï¼‰ï¼š</div>
                            <div id="remainder-coins" class="value money-amount">0 å…ƒ</div>
                        </div>
                        <div class="result-row result-total">
                            <div class="label">ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢ï¼š</div>
                            <div id="moved-coins" class="value money-amount">0 å…ƒ</div>
                        </div>
                        <div class="coin-detail" id="coin-detail">
                            <div id="coin-breakdown"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2 class="section-title">é ç•™é›¶ç”¨é‡‘ï¼ˆç›®æ¨™ 20,000 å…ƒï¼‰</h2>

                <div class="result-block compact-block result-block-coins">
                    <h3 class="subsection-title">1. ä¿ç•™ç¡¬å¹£</h3>
                    <div class="result-row compact-row">
                        <div class="label">ä¿ç•™ç¡¬å¹£ç¸½é¡ï¼ˆå¯æ•´é™¤ç™¾å…ƒçš„ç¡¬å¹£ï¼‰ï¼š</div>
                        <div id="kept-coins-total" class="value money-amount">0 å…ƒ</div>
                    </div>
                    <div id="kept-coins-detail"></div>
                </div>

                 <div class="result-block compact-block result-block-notes">
                    <h3 class="subsection-title">2. ç´™éˆ”å¡«æ»¿</h3>
                    <div id="paper-money-detail"></div>
                </div>

                <div id="balance-warning" class="warning-block" style="display: none;">
                    <div class="warning-title">æ³¨æ„ï¼</div>
                    <div id="balance-warning-text"></div>
                </div>

                <div class="result-block compact-block">
                    <div class="result-row result-total">
                        <div class="label">é ç•™é›¶ç”¨é‡‘å¯¦éš›ç¸½é¡ï¼š</div>
                        <div id="petty-cash-final" class="value money-amount">0 å…ƒ</div>
                    </div>
                </div>
            </div>

            <div class="card compact-card">
                <h2 class="section-title">ç‡Ÿæ”¶ä¸Šç¹³</h2>
                <div class="result-block compact-block">
                    <div class="result-row result-total">
                        <div class="label">ç‡Ÿæ”¶ä¸Šç¹³ç¸½é¡ï¼ˆç¸½é‡‘é¡ - é ç•™é›¶ç”¨é‡‘å¯¦éš›é¡ï¼‰ï¼š</div>
                        <div id="revenue-amount" class="value money-amount">0 å…ƒ</div>
                    </div>
                    <div id="revenue-details"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="package-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡¬å¹£ & ç´™éˆ”åŒ…è£è³‡è¨Š</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="manual-section">
                    <h4>ç¡¬å¹£è¢‹è£æ›ç®—è¡¨</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é¢é¡</th>
                                    <th>æ¯è¢‹æ•¸é‡</th>
                                    <th>æ¯è¢‹é‡‘é¡</th>
                                    <th>å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>50å…ƒ</strong></td>
                                    <td>40æš</td>
                                    <td>2,000å…ƒ</td>
                                    <td>æ¯è¢‹40æšè£</td>
                                </tr>
                                <tr>
                                    <td><strong>10å…ƒ</strong></td>
                                    <td>50æš</td>
                                    <td>500å…ƒ</td>
                                    <td>æ¯è¢‹50æšè£</td>
                                </tr>
                                <tr>
                                    <td><strong>5å…ƒ</strong></td>
                                    <td>50æš</td>
                                    <td>250å…ƒ</td>
                                    <td>æ¯è¢‹50æšè£</td>
                                </tr>
                                <tr>
                                    <td><strong>1å…ƒ</strong></td>
                                    <td>100æš</td>
                                    <td>100å…ƒ</td>
                                    <td>æ¯è¢‹100æšè£</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h4>ç´™éˆ”æ†è£æ›ç®—è¡¨</h4>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>é¢é¡</th>
                                    <th>æ¯æ†æ•¸é‡</th>
                                    <th>æ¯æ†é‡‘é¡</th>
                                    <th>å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>1000å…ƒ</strong></td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>ç„¡éœ€æ†åŒ…</td>
                                </tr>
                                <tr>
                                    <td><strong>500å…ƒ</strong></td>
                                    <td>20å¼µ</td>
                                    <td>10,000å…ƒ</td>
                                    <td>ä¸é™åˆ¶10,000å…ƒä¸€æ†</td>
                                </tr>
                                <tr>
                                    <td><strong>100å…ƒ</strong></td>
                                    <td>20å¼µ</td>
                                    <td>2,000å…ƒ</td>
                                    <td>å¼·åˆ¶2,000å…ƒä¸€æ†</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="manual-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>POSæ©Ÿç®—éŒ¢-èªªæ˜æ–‡ä»¶</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <div class="manual-section">
                    <h4>ä¸€ã€åŠŸèƒ½ç°¡ä»‹</h4>
                    <p>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…·å°ˆç‚ºé›¶å”®æ¥­ã€é¤é£²æ¥­ç­‰éœ€è¦è™•ç†å¤§é‡ç¾é‡‘äº¤æ˜“çš„ä¼æ¥­è¨­è¨ˆï¼Œèƒ½å¤ è‡ªå‹•åŒ–è™•ç†æ—¥å¸¸ç‡Ÿæ¥­çµæŸå¾Œçš„ç¾é‡‘ç›¤é»ã€é›¶ç”¨é‡‘åˆ†é…èˆ‡ç‡Ÿæ”¶ä¸Šç¹³ã€‚</p>
                </div>

                <div class="manual-section">
                    <h4>äºŒã€è¨ˆç®—è¦å‰‡</h4>

                    <h5>1. é›¶éŒ¢è™•ç†</h5>
                    <p>è™•ç†é›¶éŒ¢è¦å‰‡å¦‚ä¸‹ï¼š</p>
                    <ul>
                        <li>è¨ˆç®—å››ç¨®ç¡¬å¹£ï¼ˆ50å…ƒã€10å…ƒã€5å…ƒã€1å…ƒï¼‰ç¸½é‡‘é¡</li>
                        <li>å¾ä¸­æå–ä¸è¶³100å…ƒçš„é›¶éŒ¢ï¼ˆmod 100çš„é¤˜æ•¸ï¼‰</li>
                        <li>å°‡é€™äº›é›¶éŒ¢ç§»å…¥ç‡Ÿæ”¶ä¸Šç¹³éƒ¨åˆ†ï¼Œä¸è¨ˆå…¥é ç•™é›¶ç”¨é‡‘</li>
                    </ul>

                    <h5>2. é ç•™é›¶ç”¨é‡‘ï¼ˆå›ºå®š20,000å…ƒï¼‰</h5>
                    <p>é ç•™é›¶ç”¨é‡‘çš„çµ„æˆè¦å‰‡ï¼š</p>
                    <ul>
                        <li><strong>ç¡¬å¹£éƒ¨åˆ†</strong>ï¼šä¿ç•™æ‰€æœ‰å¯æ•´é™¤100å…ƒçš„ç¡¬å¹£ç¸½é¡</li>
                        <li><strong>ç´™éˆ”éƒ¨åˆ†</strong>ï¼šå„ªå…ˆå°‹æ‰¾èƒ½å¤ ä½¿é ç•™é›¶ç”¨é‡‘æ°å¥½ç‚º20,000å…ƒçš„500å…ƒèˆ‡100å…ƒçµ„åˆ</li>
                    </ul>

                    <h5>3. ç‡Ÿæ”¶ä¸Šç¹³</h5>
                    <p>ç‡Ÿæ”¶ä¸Šç¹³é‡‘é¡ = å…¨éƒ¨ç¸½é‡‘é¡ - é ç•™é›¶ç”¨é‡‘å¯¦éš›é‡‘é¡</p>
                </div>

                <div class="manual-section">
                    <h4>ä¸‰ã€é¢é¡æ›ç®—åŠŸèƒ½</h4>
                    <p>å¯ä»¥å°‡æŸä¸€é¢é¡çš„é‡‘é¡å¿«é€Ÿè½‰æ›ç‚ºå…¶ä»–é¢é¡ï¼Œä¸¦è‡ªå‹•æ›´æ–°åˆ°è¼¸å…¥æ¡†ä¸­ï¼š</p>
                    <ul>
                        <li>é¸æ“‡è¦è½‰å‡ºçš„é¢é¡å’Œè½‰å…¥çš„ç›®æ¨™é¢é¡</li>
                        <li>è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡</li>
                        <li>ç¢ºèªè½‰æ›å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°è¼¸å…¥æ¡†ä¸­çš„é‡‘é¡</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="exchange-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é¢é¡æ›ç®—å·¥å…·</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="exchange-section">
                    <h4>è½‰å‡ºé¢é¡</h4>
                    <div class="exchange-field">
                        <label for="exchange-amount">é‡‘é¡</label>
                        <input type="text" id="exchange-amount" placeholder="è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡" class="exchange-input" inputmode="numeric">
                    </div>
                    <div class="exchange-field">
                        <label for="exchange-from">é¸æ“‡é¢é¡</label>
                        <select id="exchange-from" class="exchange-select">
                            <option value="1000" selected>1000å…ƒ</option>
                            <option value="500">500å…ƒ</option>
                            <option value="100">100å…ƒ</option>
                            <option value="50">50å…ƒ</option>
                            <option value="10">10å…ƒ</option>
                            <option value="5">5å…ƒ</option>
                            <option value="1">1å…ƒ</option>
                        </select>
                    </div>
                    <div class="exchange-info">
                        <div>ç•¶å‰é¢é¡ç¸½é¡: <span id="from-current-amount">0</span> å…ƒ</div>
                        <div>(æ•¸é‡: <span id="from-current-count">0</span> å¼µ/æš)</div>
                        <hr style="margin: 5px 0;">
                        <div>è½‰æ›å¾Œå‰©é¤˜é‡‘é¡: <span id="from-new-amount">0</span> å…ƒ</div>
                        <div>(æ•¸é‡: <span id="from-new-count">0</span> å¼µ/æš)</div>
                    </div>
                </div>

                <div class="exchange-arrow">â†’</div>

                <div class="exchange-section">
                    <h4>è½‰å…¥é¢é¡</h4>
                    <div class="exchange-field">
                        <label for="exchange-to">é¸æ“‡é¢é¡</label>
                        <select id="exchange-to" class="exchange-select">
                            <option value="1000">1000å…ƒ</option>
                            <option value="500">500å…ƒ</option>
                            <option value="100">100å…ƒ</option>
                            <option value="50">50å…ƒ</option>
                            <option value="10">10å…ƒ</option>
                            <option value="5">5å…ƒ</option>
                            <option value="1" selected>1å…ƒ</option>
                        </select>
                    </div>
                    <div class="exchange-info">
                         <div>ç•¶å‰é¢é¡ç¸½é¡: <span id="to-current-amount">0</span> å…ƒ</div>
                         <div>(æ•¸é‡: <span id="to-current-count">0</span> å¼µ/æš)</div>
                         <hr style="margin: 5px 0;">
                         <div>è½‰æ›å¾Œç¸½é‡‘é¡: <span id="to-new-amount">0</span> å…ƒ</div>
                         <div>(æ•¸é‡: <span id="to-new-count">0</span> å¼µ/æš)</div>
                    </div>
                </div>

                <button id="exchange-confirm" class="btn btn-confirm btn-exchange">ç¢ºèªè½‰æ›</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- å¸¸æ•¸å®šç¾© ---
            const packagingRules = {
                'bundle100': { value: 2000, count: 20 }, // 100å…ƒæ†
                'bag50': { value: 2000, count: 40 },     // 50å…ƒè¢‹
                'bag10': { value: 500, count: 50 },      // 10å…ƒè¢‹
                'bag5': { value: 250, count: 50 },       // 5å…ƒè¢‹
                'bag1': { value: 100, count: 100 }       // 1å…ƒè¢‹
            };
            const denominations = [1000, 500, 100, 50, 10, 5, 1]; // é¢é¡åˆ—è¡¨

            // --- DOM å…ƒç´ ç²å– ---
            const amountInputs = {}; // ä¸»é é¢é‡‘é¡è¼¸å…¥æ¡†
            const bagInputs = {};    // ä¸»é é¢è¢‹/æ†è¼¸å…¥æ¡†
            denominations.forEach(denom => {
                amountInputs[denom] = document.getElementById(`amount${denom}`);
                const bagInput = document.getElementById(`bag${denom}`) || document.getElementById(`bundle${denom}`);
                if (bagInput) {
                    bagInputs[denom] = bagInput;
                }
            });

            const resultContainer = document.getElementById('result-container');
            const clearBtn = document.getElementById('clear-btn');
            const simulateBtn = document.getElementById('simulate-btn');
            const calculateBtn = document.getElementById('calculate-btn');

            // é¡å¤–è¨ˆç®—å€å¡Š
            const extraCalcHeader = document.querySelector('.extra-calc-header');
            const extraCalcContainer = document.querySelector('.extra-calc-container');
            const extraCalcIcon = document.querySelector('.extra-calc-header-icon');
            const lockBtn = document.getElementById('lock-btn');
            const reportTotalInput = document.getElementById('report-total');
            const collectAmountInput = document.getElementById('collect-amount');
            const pcAmountInput = document.getElementById('pc-amount');
            const extraCalcResult = document.getElementById('extra-calc-result');
            const extraCalcInputs = [reportTotalInput, collectAmountInput, pcAmountInput];

            // æ¨¡æ…‹æ¡†
            const packageModal = document.getElementById('package-modal');
            const manualModal = document.getElementById('manual-modal');
            const exchangeModal = document.getElementById('exchange-modal');
            const showPackageBtn = document.getElementById('show-package-info');
            const showManualBtn = document.getElementById('show-manual');
            const showExchangeBtn = document.getElementById('show-exchange');
            const closeBtns = document.querySelectorAll('.modal .close'); // æ›´ç²¾ç¢ºé¸æ“‡é—œé–‰æŒ‰éˆ•

            // é¢é¡æ›ç®—æ¨¡æ…‹æ¡†å…ƒç´ 
            const exchangeAmountInput = document.getElementById('exchange-amount');
            const exchangeFromSelect = document.getElementById('exchange-from');
            const exchangeToSelect = document.getElementById('exchange-to');
            const exchangeConfirmBtn = document.getElementById('exchange-confirm');
            const fromCurrentAmountSpan = document.getElementById('from-current-amount');
            const fromCurrentCountSpan = document.getElementById('from-current-count');
            const fromNewAmountSpan = document.getElementById('from-new-amount');
            const fromNewCountSpan = document.getElementById('from-new-count');
            const toCurrentAmountSpan = document.getElementById('to-current-amount');
            const toCurrentCountSpan = document.getElementById('to-current-count');
            const toNewAmountSpan = document.getElementById('to-new-amount');
            const toNewCountSpan = document.getElementById('to-new-count');


            // --- æ ¼å¼åŒ–èˆ‡è§£æå‡½æ•¸ ---

            /**
             * æ ¼å¼åŒ–æ•¸å­—ç‚ºè²¨å¹£å­—ä¸² (e.g., 1,234 å…ƒ)
             * @param {number} number - è¦æ ¼å¼åŒ–çš„æ•¸å­—
             * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²
             */
            function formatMoney(number) {
                if (isNaN(number)) return '0 å…ƒ';
                return new Intl.NumberFormat('zh-TW').format(number) + ' å…ƒ';
            }

            /**
             * æ ¼å¼åŒ–æ•¸å­—ç‚ºåŒ…å«åƒåˆ†ä½çš„å­—ä¸² (e.g., 1,234)
             * @param {number | string} number - è¦æ ¼å¼åŒ–çš„æ•¸å­—æˆ–å­—ä¸²
             * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²
             */
            function formatNumber(number) {
                const num = parseFloat(String(number).replace(/,/g, ''));
                if (isNaN(num)) return '';
                return new Intl.NumberFormat('zh-TW').format(num);
            }

             /**
             * è§£æè¼¸å…¥æ¡†çš„å€¼ç‚ºæ•¸å­— (å»é™¤é€—è™Ÿ)
             * @param {string} input - è¼¸å…¥æ¡†çš„å€¼
             * @returns {number} è§£æå¾Œçš„æ•¸å­—ï¼Œè‹¥ç„¡æ•ˆå‰‡è¿”å› 0
             */
            function parseInputValue(input) {
                if (typeof input !== 'string') return 0;
                return parseInt(input.replace(/,/g, ''), 10) || 0;
            }

            /**
             * æ ¼å¼åŒ–è¼¸å…¥æ¡†çš„å€¼ (å³æ™‚æ·»åŠ åƒåˆ†ä½)
             * @param {HTMLInputElement} inputElement - è¼¸å…¥æ¡†å…ƒç´ 
             */
            function formatInputWithCommas(inputElement) {
                 // è¨˜éŒ„ç•¶å‰å…‰æ¨™ä½ç½®
                let cursorPosition = inputElement.selectionStart;
                const originalLength = inputElement.value.length;

                let value = inputElement.value.replace(/[^\d]/g, ''); // åªä¿ç•™æ•¸å­—
                value = value.replace(/^0+/, ''); // ç§»é™¤é–‹é ­çš„é›¶

                const formattedValue = value ? formatNumber(value) : '';

                // è¨ˆç®—æ ¼å¼åŒ–å‰å¾Œé•·åº¦å·®ç•°ï¼Œä»¥èª¿æ•´å…‰æ¨™ä½ç½®
                const lengthDifference = formattedValue.length - originalLength;

                inputElement.value = formattedValue;

                // æ¢å¾©å…‰æ¨™ä½ç½®
                // å¦‚æœå€¼è®Šé•·ï¼ˆåŠ äº†é€—è™Ÿï¼‰ï¼Œå…‰æ¨™å‘å³ç§»å‹•ç›¸æ‡‰ä½æ•¸
                // å¦‚æœå€¼è®ŠçŸ­ï¼ˆåˆªäº†æ•¸å­—ï¼‰ï¼Œå…‰æ¨™å¯èƒ½éœ€è¦èª¿æ•´ï¼Œé€™è£¡ç°¡å–®è™•ç†
                const newCursorPosition = cursorPosition + lengthDifference;
                 // ç¢ºä¿å…‰æ¨™ä½ç½®æœ‰æ•ˆ
                if (newCursorPosition >= 0 && newCursorPosition <= formattedValue.length) {
                    inputElement.setSelectionRange(newCursorPosition, newCursorPosition);
                }
            }


            // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---

            /**
             * åå‘è¿­ä»£æ³•æŸ¥æ‰¾æœ€ä½³é¢é¡çµ„åˆ (å„ªå…ˆä½¿ç”¨100å…ƒ)
             * @param {number} remainingCashNeeded - éœ€è¦ç”¨100å’Œ500å…ƒè£œè¶³çš„é‡‘é¡
             * @param {number} available100Count - å¯ç”¨çš„100å…ƒå¼µæ•¸
             * @param {number} available500Count - å¯ç”¨çš„500å…ƒå¼µæ•¸
             * @returns {object} åŒ…å«æ‰¾åˆ°çµæœã€ä½¿ç”¨çš„å¼µæ•¸å’Œé‡‘é¡
             */
            function findOptimalCombination(remainingCashNeeded, available100Count, available500Count) {
                let optimal100 = 0;
                let optimal500 = 0;
                let found = false;

                // å¾æœ€å¤§å¯ç”¨100å…ƒå¼µæ•¸é–‹å§‹éæ¸›
                for (let i = available100Count; i >= 0; i--) {
                    const amount100 = i * 100;
                    const remainingFor500 = remainingCashNeeded - amount100;

                    // æª¢æŸ¥å‰©é¤˜é‡‘é¡æ˜¯å¦ç‚º500çš„å€æ•¸ä¸”å¤§æ–¼ç­‰æ–¼0
                    if (remainingFor500 >= 0 && remainingFor500 % 500 === 0) {
                        const needed500Count = remainingFor500 / 500;

                        // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„500å…ƒ
                        if (needed500Count <= available500Count) {
                            optimal100 = i;
                            optimal500 = needed500Count;
                            found = true;
                            break; // æ‰¾åˆ°æœ€ä½³çµ„åˆï¼Œåœæ­¢è¿´åœˆ
                        }
                    }
                }

                return {
                    found,
                    used100: optimal100,
                    used500: optimal500,
                    amount100: optimal100 * 100,
                    amount500: optimal500 * 500
                };
            }

             /**
             * è¨ˆç®—é›¶éŒ¢æ˜ç´°
             * @param {number} targetAmount - è¦çµ„æˆçš„é›¶éŒ¢ç¸½é¡
             * @param {object} availableAmounts - å„é¢é¡ç•¶å‰å¯ç”¨ç¸½é‡‘é¡
             * @returns {object} å„é¢é¡ä½¿ç”¨çš„æšæ•¸ { '50': count, '10': count, ... }
             */
            function getCoinsBreakdown(targetAmount, availableAmounts) {
                let remaining = targetAmount;
                const coinDenominations = [50, 10, 5, 1];
                const result = { '50': 0, '10': 0, '5': 0, '1': 0 };

                for (const denom of coinDenominations) {
                    const denomStr = denom.toString();
                    // è¨ˆç®—è©²é¢é¡æœ€å¤šå¯ç”¨çš„æšæ•¸
                    const availableCount = Math.floor(availableAmounts[denomStr] / denom);
                    // è¨ˆç®—éœ€è¦å¤šå°‘æšè©²é¢é¡çš„ç¡¬å¹£
                    const neededCount = Math.floor(remaining / denom);
                    // å¯¦éš›ä½¿ç”¨çš„æšæ•¸æ˜¯å¯ç”¨å’Œéœ€è¦ä¹‹é–“çš„æœ€å°å€¼
                    const usedCount = Math.min(availableCount, neededCount);

                    result[denomStr] = usedCount;
                    remaining -= usedCount * denom;

                    if (remaining <= 0) break; // é‡‘é¡å·²æ¹Šé½Š
                }

                // å¦‚æœç„¡æ³•å®Œå…¨æ¹Šé½Š (ç†è«–ä¸Šç”¨ 1 å…ƒä¸€å®šå¯ä»¥)ï¼Œé€™è£¡å¯ä»¥åŠ éŒ¯èª¤è™•ç†
                 if (remaining > 0) {
                    console.warn(`ç„¡æ³•å®Œå…¨æ¹Šé½Šé›¶éŒ¢ ${targetAmount}ï¼Œå‰©é¤˜ ${remaining}`);
                    // å¯èƒ½éœ€è¦å›æº¯æˆ–èª¿æ•´é‚è¼¯ï¼Œä½†åŸºæ–¼æœ‰ 1 å…ƒï¼Œæ‡‰è©²éƒ½èƒ½æ¹Šé½Š
                }

                return result;
            }


            /**
             * è¨ˆç®—æŒ‡å®šé¢é¡çš„è¢‹/æ†æ•¸å’Œæ•£è£æ•¸é‡
             * @param {number} totalCount - è©²é¢é¡ç¸½æš/å¼µæ•¸
             * @param {number} denomination - é¢é¡å€¼
             * @returns {object} åŒ…å«è¢‹/æ†æ•¸ã€æ•£è£æ•¸ã€æ•£è£é‡‘é¡
             */
            function calculatePackages(totalCount, denomination) {
                let packageKey = '';
                if (denomination === 100) packageKey = 'bundle100';
                else if (denomination === 50) packageKey = 'bag50';
                else if (denomination === 10) packageKey = 'bag10';
                else if (denomination === 5) packageKey = 'bag5';
                else if (denomination === 1) packageKey = 'bag1';
                else return { packages: 0, loose: totalCount, looseAmount: totalCount * denomination }; // éæ‰“åŒ…é¢é¡

                const rule = packagingRules[packageKey];
                if (!rule) return { packages: 0, loose: totalCount, looseAmount: totalCount * denomination };

                const packages = Math.floor(totalCount / rule.count);
                const loose = totalCount % rule.count;
                const looseAmount = loose * denomination;
                return { packages, loose, looseAmount };
            }

            // --- äº‹ä»¶è™•ç†å‡½æ•¸ ---

            /**
             * æ¸…é™¤æ‰€æœ‰è¼¸å…¥å’Œçµæœ
             */
            function clearAll() {
                // æ¸…é™¤ä¸»è¼¸å…¥æ¡†
                Object.values(amountInputs).forEach(input => {
                    input.value = '';
                    input.classList.remove('input-error');
                    const errorMsg = document.getElementById(`error${input.dataset.denomination}`);
                    if (errorMsg) errorMsg.classList.remove('active');
                });
                Object.values(bagInputs).forEach(input => input.value = '');

                // æ¸…é™¤é¡å¤–è¨ˆç®—å€å¡Š
                extraCalcInputs.forEach(input => input.value = '');
                updateExtraCalc(); // æ›´æ–°é¡¯ç¤ºç‚º 0

                // éš±è—çµæœå€å¡Š
                resultContainer.classList.remove('active');

                // é‡ç½®éŒ¯èª¤æç¤º
                document.getElementById('petty-cash-box').classList.remove('error');
                document.getElementById('balance-warning').style.display = 'none';
            }

            /**
             * å¡«å…¥æ¨¡æ“¬æ•¸å€¼
             */
            function simulateValues() {
                clearAll(); // æ¸…é™¤èˆŠå€¼
                amountInputs['1000'].value = '16,000';
                amountInputs['500'].value = '17,000';
                amountInputs['100'].value = '6,100';
                amountInputs['50'].value = '1,400';
                amountInputs['10'].value = '910';
                amountInputs['5'].value = '410';
                amountInputs['1'].value = '51';

                // æ¨¡æ“¬è¢‹/æ†æ•¸ (å¯é¸)
                // bagInputs['100'].value = '1'; // 1æ†100å…ƒ = 2000
                bagInputs['50'].value = '1'; // 1è¢‹50å…ƒ = 2000
                // bagInputs['10'].value = '1'; // 1è¢‹10å…ƒ = 500
                // bagInputs['5'].value = '1'; // 1è¢‹5å…ƒ = 250
                bagInputs['1'].value = '1'; // 1è¢‹1å…ƒ = 100
            }

            /**
             * ä¸»è¨ˆç®—æµç¨‹
             */
            function calculate() {
                 // 1. é©—è­‰è¼¸å…¥
                let hasError = false;
                let currentAmounts = {}; // å„²å­˜ç•¶å‰å„é¢é¡çš„ç¸½é‡‘é¡ (åŒ…å«è¢‹/æ†)
                let currentCounts = {}; // å„²å­˜ç•¶å‰å„é¢é¡çš„ç¸½å¼µ/æšæ•¸

                denominations.forEach(denom => {
                    const input = amountInputs[denom];
                    const bagInput = bagInputs[denom];
                    const errorElement = document.getElementById(`error${denom}`);
                    let totalAmountForDenom = parseInputValue(input.value);

                    // æ¸…é™¤èˆŠéŒ¯èª¤
                    input.classList.remove('input-error');
                    if (errorElement) errorElement.classList.remove('active');

                    // åŠ ä¸Šè¢‹/æ†çš„é‡‘é¡
                    if (bagInput && bagInput.value) {
                        const packages = parseInt(bagInput.value, 10) || 0;
                        if (packages > 0) {
                            const packageType = bagInput.dataset.packageType; // 'bag' or 'bundle'
                            const packageKey = `${packageType}${denom}`;
                            if (packagingRules[packageKey]) {
                                totalAmountForDenom += packages * packagingRules[packageKey].value;
                            }
                        }
                    }

                    // é©—è­‰ç¸½é‡‘é¡æ˜¯å¦ç‚ºé¢é¡çš„å€æ•¸
                    if (totalAmountForDenom % denom !== 0) {
                        input.classList.add('input-error');
                        if (errorElement) errorElement.classList.add('active');
                        hasError = true;
                    }

                    currentAmounts[denom] = totalAmountForDenom;
                    currentCounts[denom] = Math.floor(totalAmountForDenom / denom);
                });

                if (hasError) {
                    alert('éƒ¨åˆ†é‡‘é¡è¼¸å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç´…è‰²æ¡†æ¨™ç¤ºçš„æ¬„ä½ï¼');
                    resultContainer.classList.remove('active'); // éš±è—èˆŠçµæœ
                    return;
                }

                // 2. è¨ˆç®—ç¸½é‡‘é¡
                const totalAmount = Object.values(currentAmounts).reduce((sum, val) => sum + val, 0);

                // 3. é›¶éŒ¢è™•ç†
                const totalCoinsAmount = currentAmounts['50'] + currentAmounts['10'] + currentAmounts['5'] + currentAmounts['1'];
                const remainderCoinsAmount = totalCoinsAmount % 100; // ä¸è¶³ç™¾å…ƒçš„é›¶éŒ¢
                const keptCoinsAmount = totalCoinsAmount - remainderCoinsAmount; // å¯æ¹Šæˆç™¾å…ƒçš„ç¡¬å¹£ç¸½é¡

                // è¨ˆç®—ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢æ˜ç´° (å¾ç¸½ç¡¬å¹£ä¸­å–å‡º remainderCoinsAmount)
                const smallCoinsBreakdown = getCoinsBreakdown(remainderCoinsAmount, currentAmounts);

                // 4. è¨ˆç®—é ç•™é›¶ç”¨é‡‘ (ç›®æ¨™ 20,000)
                const pettyCashTarget = 20000;
                // éœ€è¦ç”¨ç´™éˆ”è£œè¶³çš„é‡‘é¡ = ç›®æ¨™ - ä¿ç•™çš„ç¡¬å¹£é‡‘é¡
                const remainingCashNeeded = pettyCashTarget - keptCoinsAmount;

                let actualPettyCash = 0; // å¯¦éš›é ç•™çš„é›¶ç”¨é‡‘ç¸½é¡
                let balanceGap = 0;      // èˆ‡ç›®æ¨™çš„å·®é¡
                let used100ForPettyCash = 0;
                let used500ForPettyCash = 0;
                let pettyCashPaperAmount = 0; // é›¶ç”¨é‡‘ä¸­çš„ç´™éˆ”ç¸½é¡

                // è¨ˆç®—é ç•™é›¶ç”¨é‡‘ä¸­ä¿ç•™çš„ç¡¬å¹£æ˜ç´° (ç¸½ç¡¬å¹£æ•¸ - ç§»å…¥ç‡Ÿæ”¶çš„ç¡¬å¹£æ•¸)
                const keptCoinsDetailCounts = {
                    '50': currentCounts['50'] - smallCoinsBreakdown['50'],
                    '10': currentCounts['10'] - smallCoinsBreakdown['10'],
                    '5': currentCounts['5'] - smallCoinsBreakdown['5'],
                    '1': currentCounts['1'] - smallCoinsBreakdown['1']
                };

                // è¨ˆç®—ä¿ç•™ç¡¬å¹£çš„è¢‹è£æƒ…æ³
                const keptCoinsPackages = {};
                [50, 10, 5, 1].forEach(denom => {
                    keptCoinsPackages[denom] = calculatePackages(keptCoinsDetailCounts[denom], denom);
                });


                // åˆ¤æ–·æ˜¯å¦éœ€è¦ç”¨ç´™éˆ”
                if (remainingCashNeeded > 0) {
                    // ä½¿ç”¨åå‘è¿­ä»£æ³•æ‰¾å‡ºæœ€ä½³çµ„åˆ (å„ªå…ˆç”¨100å…ƒæ¹Š)
                    const optimalCombination = findOptimalCombination(
                        remainingCashNeeded,
                        currentCounts['100'], // å¯ç”¨çš„100å…ƒå¼µæ•¸
                        currentCounts['500']  // å¯ç”¨çš„500å…ƒå¼µæ•¸
                    );

                    if (optimalCombination.found) {
                        // æ‰¾åˆ°äº†å‰›å¥½çš„çµ„åˆ
                        used100ForPettyCash = optimalCombination.used100;
                        used500ForPettyCash = optimalCombination.used500;
                        pettyCashPaperAmount = optimalCombination.amount100 + optimalCombination.amount500;
                        actualPettyCash = keptCoinsAmount + pettyCashPaperAmount;
                        balanceGap = 0; // å‰›å¥½é”åˆ°ç›®æ¨™
                    } else {
                         // æ‰¾ä¸åˆ°å‰›å¥½çš„çµ„åˆï¼Œç›¡é‡æ¹Š (å„ªå…ˆç”¨å¤§é¢é¡)
                        // å…ˆç”¨ 500 å…ƒ
                        const max500Count = Math.min(
                            Math.floor(remainingCashNeeded / 500),
                            currentCounts['500']
                        );
                        used500ForPettyCash = max500Count;
                        const amountFrom500 = max500Count * 500;

                        // å†ç”¨ 100 å…ƒè£œè¶³å‰©é¤˜
                        const stillNeeded = remainingCashNeeded - amountFrom500;
                        const max100Count = Math.min(
                            Math.floor(stillNeeded / 100), // æœ€å¤šéœ€è¦å¤šå°‘å¼µ100
                            currentCounts['100'] // å¯¦éš›æœ‰å¤šå°‘å¼µ100
                        );
                        used100ForPettyCash = max100Count;
                        const amountFrom100 = max100Count * 100;

                        pettyCashPaperAmount = amountFrom500 + amountFrom100;
                        actualPettyCash = keptCoinsAmount + pettyCashPaperAmount;
                        balanceGap = pettyCashTarget - actualPettyCash; // è¨ˆç®—å·®é¡
                    }
                } else {
                    // ä¸éœ€è¦ç´™éˆ”ï¼Œæˆ–ç¡¬å¹£å·²è¶…éç›®æ¨™
                    actualPettyCash = keptCoinsAmount; // é›¶ç”¨é‡‘å°±æ˜¯ä¿ç•™çš„ç¡¬å¹£
                    balanceGap = pettyCashTarget - actualPettyCash; // å¯èƒ½ç‚ºè² æ•¸
                }

                // 5. è¨ˆç®—ç‡Ÿæ”¶ä¸Šç¹³
                const revenueAmount = totalAmount - actualPettyCash;

                // è¨ˆç®—å„é¢é¡åœ¨ç‡Ÿæ”¶ä¸Šç¹³ä¸­çš„æ•¸é‡
                const revenueDetailCounts = {
                    '1000': currentCounts['1000'], // 1000å…ƒå…¨éƒ¨ä¸Šç¹³
                    '500': currentCounts['500'] - used500ForPettyCash,
                    '100': currentCounts['100'] - used100ForPettyCash,
                    '50': smallCoinsBreakdown['50'], // ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢
                    '10': smallCoinsBreakdown['10'],
                    '5': smallCoinsBreakdown['5'],
                    '1': smallCoinsBreakdown['1']
                };
                 // è¨ˆç®—ç‡Ÿæ”¶ä¸Šç¹³çš„è¢‹/æ†æ•¸
                const revenuePackages = {};
                 [100, 50, 10, 5, 1].forEach(denom => { // 1000å’Œ500ä¸æ‰“åŒ…
                    revenuePackages[denom] = calculatePackages(revenueDetailCounts[denom], denom);
                });


                // 6. æ›´æ–° UI é¡¯ç¤º
                updateUI(totalAmount, remainderCoinsAmount, totalCoinsAmount, keptCoinsAmount, actualPettyCash, revenueAmount, balanceGap, smallCoinsBreakdown, keptCoinsDetailCounts, keptCoinsPackages, used100ForPettyCash, used500ForPettyCash, pettyCashPaperAmount, remainingCashNeeded, revenueDetailCounts, revenuePackages);

                // é¡¯ç¤ºçµæœå€åŸŸ
                resultContainer.classList.add('active');
            }

            /**
             * æ›´æ–° UI é¡¯ç¤ºè¨ˆç®—çµæœ
             * @param {...any} args - åŒ…å«æ‰€æœ‰è¨ˆç®—çµæœçš„åƒæ•¸
             */
            function updateUI(totalAmount, remainderCoinsAmount, totalCoinsAmount, keptCoinsAmount, actualPettyCash, revenueAmount, balanceGap, smallCoinsBreakdown, keptCoinsDetailCounts, keptCoinsPackages, used100ForPettyCash, used500ForPettyCash, pettyCashPaperAmount, remainingCashNeeded, revenueDetailCounts, revenuePackages) {
                // --- çµæœç¸½è¦½ ---
                document.getElementById('total-amount').textContent = formatMoney(totalAmount);
                document.getElementById('summary-small-coins').textContent = formatMoney(remainderCoinsAmount);
                document.getElementById('summary-revenue').textContent = formatMoney(revenueAmount);
                document.getElementById('petty-cash-actual').textContent = formatMoney(actualPettyCash);

                // é ç•™é›¶ç”¨é‡‘ç›®æ¨™é”æˆç‹€æ…‹
                const pettyBoxElement = document.getElementById('petty-cash-box');
                pettyBoxElement.classList.toggle('error', balanceGap !== 0);

                // --- é›¶éŒ¢è™•ç† ---
                document.getElementById('total-coins').textContent = formatMoney(totalCoinsAmount);
                document.getElementById('remainder-coins').textContent = formatMoney(remainderCoinsAmount);
                document.getElementById('moved-coins').textContent = formatMoney(remainderCoinsAmount);

                // ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢æ˜ç´°
                let coinBreakdownHTML = '';
                if (remainderCoinsAmount > 0) {
                    const parts = [];
                    [50, 10, 5, 1].forEach(denom => {
                        if (smallCoinsBreakdown[denom] > 0) {
                            parts.push(`${denom}å…ƒÃ—${smallCoinsBreakdown[denom]}`);
                        }
                    });
                    coinBreakdownHTML = `<div class="highlight">${formatMoney(remainderCoinsAmount)} = ${parts.join(' + ')}</div>`;
                } else {
                     coinBreakdownHTML = '<div class="highlight">ç„¡é›¶éŒ¢ç§»å…¥ç‡Ÿæ”¶</div>';
                }
                document.getElementById('coin-breakdown').innerHTML = coinBreakdownHTML;

                // --- é ç•™é›¶ç”¨é‡‘ ---
                // 1. ä¿ç•™ç¡¬å¹£
                document.getElementById('kept-coins-total').textContent = formatMoney(keptCoinsAmount);
                let keptCoinsHTML = '';
                [50, 10, 5, 1].forEach(denom => {
                    const count = keptCoinsDetailCounts[denom];
                    const amount = count * denom;
                    const packageInfo = keptCoinsPackages[denom];
                    let packageText = '';
                    if (packageInfo.packages > 0) {
                        packageText += `${packageInfo.packages}${denom === 100 ? 'æ†' : 'è¢‹'}`;
                    }
                    if (packageInfo.loose > 0) {
                        if (packageText) packageText += ' + ';
                        packageText += `${formatMoney(packageInfo.looseAmount)} (${packageInfo.loose}æš)`;
                    }
                    if (!packageText && amount === 0) {
                        packageText = '0æš';
                    }

                    keptCoinsHTML += `
                        <div class="result-row compact-row">
                            <div class="label">${denom}å…ƒï¼š</div>
                            <div class="value">
                                <span class="money-amount money-amount-${denom}">${formatMoney(amount)}</span>
                                ${packageText ? `<span class="money-package">${packageText}</span>` : ''}
                            </div>
                        </div>
                    `;
                });
                keptCoinsHTML += `
                    <div class="result-row result-total">
                        <div class="label">ç¡¬å¹£åˆè¨ˆï¼š</div>
                        <div class="value money-amount">${formatMoney(keptCoinsAmount)}</div>
                    </div>
                `;
                document.getElementById('kept-coins-detail').innerHTML = keptCoinsHTML;

                // 2. ç´™éˆ”å¡«æ»¿
                let paperMoneyHTML = '';
                 const paperDenominations = [500, 100]; // ç´™éˆ”é¢é¡
                 const paperCounts = { '500': used500ForPettyCash, '100': used100ForPettyCash };

                 paperDenominations.forEach(denom => {
                     const count = paperCounts[denom];
                     const amount = count * denom;
                     let packageText = `${count} å¼µ`;
                     if (denom === 100) {
                         const bundles = calculatePackages(count, 100);
                         if (bundles.packages > 0) {
                             packageText = `${bundles.packages}æ†`;
                             if (bundles.loose > 0) {
                                 packageText += ` + ${bundles.loose}å¼µ`;
                             }
                         }
                     }

                     paperMoneyHTML += `
                         <div class="result-row compact-row">
                             <div class="label">${denom}å…ƒï¼š</div>
                             <div class="value">
                                 <span class="money-amount money-amount-${denom}">${formatMoney(amount)}</span>
                                 <span class="money-package">${packageText}</span>
                             </div>
                         </div>
                     `;
                 });

                paperMoneyHTML += `
                    <div class="result-row result-total">
                        <div class="label">ç´™éˆ”åˆè¨ˆï¼š</div>
                        <div class="value money-amount">${formatMoney(pettyCashPaperAmount)}</div>
                        ${remainingCashNeeded > 0 ? `<span class="note">ï¼ˆç›®æ¨™è£œè¶³é‡‘é¡ï¼š${formatMoney(remainingCashNeeded)}ï¼‰</span>` : ''}
                    </div>
                `;
                document.getElementById('paper-money-detail').innerHTML = paperMoneyHTML;

                // é ç•™é›¶ç”¨é‡‘ç¸½è¨ˆ
                document.getElementById('petty-cash-final').textContent = formatMoney(actualPettyCash);

                // é ç•™é›¶ç”¨é‡‘å·®é¡è­¦å‘Š
                const balanceWarningElement = document.getElementById('balance-warning');
                const balanceWarningTextElement = document.getElementById('balance-warning-text');
                if (balanceGap !== 0) {
                    balanceWarningElement.style.display = 'block';
                    let warningText = `<p>é ç•™é›¶ç”¨é‡‘å¯¦éš›ç‚º <strong>${formatMoney(actualPettyCash)}</strong>ï¼Œ`;
                    if (balanceGap > 0) { // å°‘äº†
                        warningText += `æ¯”ç›®æ¨™é‡‘é¡å°‘äº† <strong>${formatMoney(balanceGap)}</strong>ã€‚</p>`;
                        warningText += `<p>åŸå› ï¼šå¯ç”¨çš„ 100 å…ƒæˆ– 500 å…ƒç´™éˆ”ä¸è¶³ä»¥è£œè¶³å·®é¡ã€‚</p>`;
                        warningText += `<p>å»ºè­°ï¼šæª¢æŸ¥è¼¸å…¥çš„ç´™éˆ”é‡‘é¡æ˜¯å¦æ­£ç¢ºï¼Œæˆ–èª¿æ•´ç¾é‡‘çµæ§‹ã€‚</p>`;
                    } else { // å¤šäº† (ç†è«–ä¸Šåªæœƒç™¼ç”Ÿåœ¨ç¡¬å¹£è¶…é2è¬æ™‚)
                         warningText += `æ¯”ç›®æ¨™é‡‘é¡å¤šäº† <strong>${formatMoney(Math.abs(balanceGap))}</strong>ã€‚</p>`;
                         warningText += `<p>åŸå› ï¼šä¿ç•™çš„ç¡¬å¹£é‡‘é¡å·²è¶…é 20,000 å…ƒã€‚</p>`;
                         warningText += `<p>å»ºè­°ï¼šå°‡éƒ¨åˆ†ç¡¬å¹£æ›æˆç´™éˆ”ï¼Œæˆ–ç¢ºèªè¨ˆç®—è¦å‰‡ã€‚</p>`;
                    }
                    balanceWarningTextElement.innerHTML = warningText;
                } else {
                    balanceWarningElement.style.display = 'none';
                }

                // --- ç‡Ÿæ”¶ä¸Šç¹³ ---
                document.getElementById('revenue-amount').textContent = formatMoney(revenueAmount);
                let revenueHTML = '';
                const revenueDenominations = [1000, 500, 100, 50, 10, 5, 1];

                revenueDenominations.forEach(denom => {
                    const count = revenueDetailCounts[denom];
                    if (count > 0) {
                        const amount = count * denom;
                        let packageText = '';
                         if (denom <= 100) { // åªé¡¯ç¤º 100 å…ƒåŠä»¥ä¸‹é¢é¡çš„æ‰“åŒ…è³‡è¨Š
                             const packageInfo = revenuePackages[denom];
                             if (packageInfo.packages > 0) {
                                 packageText += `${packageInfo.packages}${denom === 100 ? 'æ†' : 'è¢‹'}`;
                             }
                             if (packageInfo.loose > 0) {
                                 if (packageText) packageText += ' + ';
                                 packageText += `${formatMoney(packageInfo.looseAmount)} (${packageInfo.loose}${denom === 100 ? 'å¼µ' : 'æš'})`;
                             }
                             if (!packageText) { // å¦‚æœæ²’æœ‰æ‰“åŒ…ï¼Œé¡¯ç¤ºç¸½æ•¸
                                packageText = `${count}${denom === 100 ? 'å¼µ' : 'æš'}`;
                             }
                         } else { // 1000, 500 åªé¡¯ç¤ºå¼µæ•¸
                             packageText = `${count} å¼µ`;
                         }


                        revenueHTML += `
                            <div class="result-row compact-row">
                                <div class="label">${denom}å…ƒï¼š</div>
                                <div class="value">
                                    <span class="money-amount money-amount-${denom}">${formatMoney(amount)}</span>
                                    ${packageText ? `<span class="money-package">${packageText}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                 if (!revenueHTML) {
                     revenueHTML = '<div class="result-row compact-row"><div class="label">ç„¡ç‡Ÿæ”¶éœ€ä¸Šç¹³</div><div class="value"></div></div>';
                 }

                document.getElementById('revenue-details').innerHTML = revenueHTML;
            }


            // --- é¢é¡æ›ç®—åŠŸèƒ½ ---

            /**
             * åˆå§‹åŒ–é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ï¼Œè®€å–ç•¶å‰ä¸»é é¢æ•¸å€¼
             */
            function initExchangeModal() {
                exchangeAmountInput.value = ''; // æ¸…ç©ºè½‰æ›é‡‘é¡è¼¸å…¥

                // ç¢ºä¿æ‰€æœ‰ä¸»é é¢è¼¸å…¥æ¡†éƒ½æœ‰å€¼ï¼ˆè‡³å°‘ç‚º '0' ä»¥ä¾¿è¨ˆç®—ï¼‰
                 Object.values(amountInputs).forEach(input => {
                     if (!input.value.trim()) {
                         input.value = '0';
                     }
                 });

                updateExchangeInfo(); // æ ¹æ“šç•¶å‰é¸æ“‡çš„é¢é¡æ›´æ–°é¡¯ç¤ºè³‡è¨Š
            }

            /**
             * æ›´æ–°é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ä¸­çš„è³‡è¨Šé¡¯ç¤º
             */
            function updateExchangeInfo() {
                const exchangeAmount = parseInputValue(exchangeAmountInput.value);
                const fromDenom = parseInt(exchangeFromSelect.value);
                const toDenom = parseInt(exchangeToSelect.value);

                if (isNaN(fromDenom) || isNaN(toDenom)) return; // é˜²æ­¢åˆå§‹åŒ–æ™‚å‡ºéŒ¯

                // ç²å–ç•¶å‰ä¸»é é¢çš„é‡‘é¡å’Œæ•¸é‡
                const fromInput = amountInputs[fromDenom];
                const toInput = amountInputs[toDenom];
                const fromCurrentAmount = parseInputValue(fromInput.value);
                const toCurrentAmount = parseInputValue(toInput.value);
                const fromCurrentCount = Math.floor(fromCurrentAmount / fromDenom);
                const toCurrentCount = Math.floor(toCurrentAmount / toDenom);

                // é¡¯ç¤ºç•¶å‰ç‹€æ…‹
                fromCurrentAmountSpan.textContent = formatNumber(fromCurrentAmount);
                fromCurrentCountSpan.textContent = fromCurrentCount;
                toCurrentAmountSpan.textContent = formatNumber(toCurrentAmount);
                toCurrentCountSpan.textContent = toCurrentCount;

                // --- è¨ˆç®—é è¦½è½‰æ›çµæœ ---
                let validExchangeAmount = 0;
                let fromNewAmount = fromCurrentAmount;
                let fromNewCount = fromCurrentCount;
                let toNewAmount = toCurrentAmount;
                let toNewCount = toCurrentCount;

                if (exchangeAmount > 0 && fromDenom !== toDenom) {
                    // é©—è­‰è½‰æ›é‡‘é¡æ˜¯å¦ç‚ºè½‰å‡ºé¢é¡çš„å€æ•¸
                    if (exchangeAmount % fromDenom !== 0) {
                        // å¯ä»¥é¸æ“‡æç¤ºç”¨æˆ¶ï¼Œæˆ–è€…è‡ªå‹•èª¿æ•´
                        // é€™è£¡æˆ‘å€‘å…ˆä¸è‡ªå‹•èª¿æ•´ï¼Œè®“ç”¨æˆ¶è¼¸å…¥æ­£ç¢ºçš„å€æ•¸
                        // alert(`è½‰æ›é‡‘é¡ ${exchangeAmount} ä¸æ˜¯ ${fromDenom} çš„å€æ•¸`);
                        // å¯ä»¥åœ¨æ­¤è™•æ¸…ç©ºé è¦½æˆ–é¡¯ç¤ºéŒ¯èª¤æç¤º
                        fromNewAmountSpan.textContent = '---';
                        fromNewCountSpan.textContent = '---';
                        toNewAmountSpan.textContent = '---';
                        toNewCountSpan.textContent = '---';
                        return; // ä¸ç¹¼çºŒè¨ˆç®—é è¦½
                    }

                    // é©—è­‰è½‰æ›é‡‘é¡æ˜¯å¦è¶…éå¯ç”¨é¤˜é¡
                    if (exchangeAmount > fromCurrentAmount) {
                        // alert(`è½‰æ›é‡‘é¡ ${formatMoney(exchangeAmount)} è¶…é ${fromDenom}å…ƒ å¯ç”¨é¤˜é¡ ${formatMoney(fromCurrentAmount)}`);
                        // å¯ä»¥åœ¨æ­¤è™•æ¸…ç©ºé è¦½æˆ–é¡¯ç¤ºéŒ¯èª¤æç¤º
                        fromNewAmountSpan.textContent = '---';
                        fromNewCountSpan.textContent = '---';
                        toNewAmountSpan.textContent = '---';
                        toNewCountSpan.textContent = '---';
                        return; // ä¸ç¹¼çºŒè¨ˆç®—é è¦½
                    }

                    validExchangeAmount = exchangeAmount; // é‡‘é¡æœ‰æ•ˆ

                    // è¨ˆç®—è½‰æ›å¾Œçµæœ
                    fromNewAmount = fromCurrentAmount - validExchangeAmount;
                    fromNewCount = Math.floor(fromNewAmount / fromDenom);
                    toNewAmount = toCurrentAmount + validExchangeAmount;
                    toNewCount = Math.floor(toNewAmount / toDenom);
                }

                // æ›´æ–°é è¦½é¡¯ç¤º
                fromNewAmountSpan.textContent = formatNumber(fromNewAmount);
                fromNewCountSpan.textContent = fromNewCount;
                toNewAmountSpan.textContent = formatNumber(toNewAmount);
                toNewCountSpan.textContent = toNewCount;
            }

            /**
             * åŸ·è¡Œé¢é¡è½‰æ›ï¼Œæ›´æ–°ä¸»é é¢è¼¸å…¥æ¡†
             */
            function performExchange() {
                const exchangeAmount = parseInputValue(exchangeAmountInput.value);
                const fromDenom = parseInt(exchangeFromSelect.value);
                const toDenom = parseInt(exchangeToSelect.value);

                if (exchangeAmount <= 0) {
                    alert('è«‹è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡ï¼');
                    return;
                }

                if (isNaN(fromDenom) || isNaN(toDenom)) {
                     alert('è«‹é¸æ“‡æœ‰æ•ˆçš„è½‰å‡ºå’Œè½‰å…¥é¢é¡ï¼');
                    return;
                }

                if (fromDenom === toDenom) {
                    alert('è½‰å‡ºé¢é¡å’Œè½‰å…¥é¢é¡ä¸èƒ½ç›¸åŒï¼');
                    return;
                }

                // å†æ¬¡é©—è­‰é‡‘é¡
                if (exchangeAmount % fromDenom !== 0) {
                    alert(`è½‰æ›é‡‘é¡ ${formatMoney(exchangeAmount)} å¿…é ˆæ˜¯ ${fromDenom} å…ƒçš„å€æ•¸ï¼`);
                    return;
                }

                const fromInput = amountInputs[fromDenom];
                const toInput = amountInputs[toDenom];
                const fromCurrentAmount = parseInputValue(fromInput.value);

                if (exchangeAmount > fromCurrentAmount) {
                    alert(`è½‰æ›é‡‘é¡ ${formatMoney(exchangeAmount)} è¶…é ${fromDenom}å…ƒ å¯ç”¨é¤˜é¡ ${formatMoney(fromCurrentAmount)}`);
                    return;
                }

                // --- åŸ·è¡Œè½‰æ› ---
                const toCurrentAmount = parseInputValue(toInput.value);

                const fromNewAmount = fromCurrentAmount - exchangeAmount;
                const toNewAmount = toCurrentAmount + exchangeAmount;

                // æ›´æ–°ä¸»é é¢è¼¸å…¥æ¡†çš„å€¼
                fromInput.value = formatNumber(fromNewAmount); // ä½¿ç”¨ formatNumber æ·»åŠ åƒåˆ†ä½
                toInput.value = formatNumber(toNewAmount);

                // è§¸ç™¼ä¸»é é¢è¼¸å…¥æ¡†çš„ input äº‹ä»¶ï¼Œä»¥ä¾¿å¯èƒ½å­˜åœ¨çš„å…¶ä»–é‚è¼¯ï¼ˆä¾‹å¦‚è¢‹/æ†è¨ˆç®—ï¼‰èƒ½æ›´æ–°
                fromInput.dispatchEvent(new Event('input', { bubbles: true }));
                toInput.dispatchEvent(new Event('input', { bubbles: true }));


                // é—œé–‰æ¨¡æ…‹çª—
                exchangeModal.style.display = 'none';
                alert('é¢é¡è½‰æ›æˆåŠŸï¼');
            }


             // --- é¡å¤–è¨ˆç®—å€å¡ŠåŠŸèƒ½ ---
            let isExtraCalcLocked = false;

            function toggleExtraCalcLock() {
                isExtraCalcLocked = !isExtraCalcLocked;
                lockBtn.textContent = isExtraCalcLocked ? 'ğŸ”’' : 'ğŸ”“';
                lockBtn.classList.toggle('locked', isExtraCalcLocked);
                lockBtn.title = isExtraCalcLocked ? 'é»æ“Šè§£é–è¼¸å…¥æ¡†' : 'é»æ“Šé–å®šè¼¸å…¥æ¡†';
                extraCalcInputs.forEach(input => input.disabled = isExtraCalcLocked);
                 // å¦‚æœè§£é–ï¼Œç«‹å³æ›´æ–°ä¸€æ¬¡è¨ˆç®—çµæœ
                if (!isExtraCalcLocked) {
                    updateExtraCalc();
                }
            }

            function updateExtraCalc() {
                if (isExtraCalcLocked) return; // é–å®šæ™‚ä¸è¨ˆç®—

                const reportTotal = parseInputValue(reportTotalInput.value);
                const collectAmount = parseInputValue(collectAmountInput.value);
                const pcAmount = parseInputValue(pcAmountInput.value);
                const result = reportTotal + collectAmount - pcAmount;
                extraCalcResult.textContent = 'è¨ˆç®—çµæœï¼š' + formatMoney(result);
            }

            // --- äº‹ä»¶ç¶å®š ---

            // æ¸…é™¤æŒ‰éˆ•
            clearBtn.addEventListener('click', clearAll);

            // æ¨¡æ“¬æ•¸å€¼æŒ‰éˆ•
            simulateBtn.addEventListener('click', simulateValues);

            // è¨ˆç®—æŒ‰éˆ•
            calculateBtn.addEventListener('click', calculate);

            // æŠ˜ç–Šå€å¡Š
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', function() {
                    this.classList.toggle('collapsed');
                    this.nextElementSibling.classList.toggle('collapsed');
                });
            });

            // é¡å¤–è¨ˆç®—å€å¡ŠæŠ˜ç–Šèˆ‡é–å®š
            extraCalcHeader.addEventListener('click', (e) => {
                 // ç¢ºä¿é»æ“Šçš„ä¸æ˜¯é–å®šæŒ‰éˆ•æœ¬èº«
                 if (!e.target.closest('#lock-btn')) {
                    extraCalcContainer.classList.toggle('collapsed');
                    extraCalcIcon.classList.toggle('collapsed');
                 }
            });
            lockBtn.addEventListener('click', toggleExtraCalcLock);
            extraCalcInputs.forEach(input => {
                input.addEventListener('input', () => {
                    formatInputWithCommas(input); // æ·»åŠ åƒåˆ†ä½
                    updateExtraCalc(); // å³æ™‚æ›´æ–°è¨ˆç®—çµæœ
                });
            });


            // ä¸»é é¢é‡‘é¡è¼¸å…¥æ¡†äº‹ä»¶ (æ ¼å¼åŒ– + é©—è­‰)
            Object.values(amountInputs).forEach(input => {
                const denomination = parseInt(input.dataset.denomination);

                // å³æ™‚æ ¼å¼åŒ–åƒåˆ†ä½
                input.addEventListener('input', function() {
                    formatInputWithCommas(this);
                });

                // å¤±å»ç„¦é»æ™‚é©—è­‰æ˜¯å¦ç‚ºé¢é¡å€æ•¸
                input.addEventListener('blur', function() {
                    const value = parseInputValue(this.value);
                    const errorElement = document.getElementById(`error${denomination}`);

                    this.classList.remove('input-error');
                    if (errorElement) errorElement.classList.remove('active');

                    if (this.value.trim() === '') return; // ç©ºå€¼ä¸é©—è­‰

                    if (value % denomination !== 0) {
                        // è‡ªå‹•èª¿æ•´ç‚ºæœ€æ¥è¿‘çš„å€æ•¸ (å‘ä¸‹å–æ•´)
                        const adjusted = Math.floor(value / denomination) * denomination;
                        this.value = formatNumber(adjusted); // æ ¼å¼åŒ–å¾Œå¡«å›
                        // å¯ä»¥é¸æ“‡æ€§åœ°æç¤ºç”¨æˆ¶å·²è¢«èª¿æ•´
                        // alert(`è¼¸å…¥é‡‘é¡ ${value} å·²è‡ªå‹•èª¿æ•´ç‚º ${denomination} çš„å€æ•¸ ${adjusted}`);
                        // æˆ–è€…çŸ­æš«é¡¯ç¤ºéŒ¯èª¤æç¤º
                        if (errorElement) {
                            errorElement.textContent = `å·²è‡ªå‹•èª¿æ•´ç‚º ${denomination} çš„å€æ•¸`;
                            errorElement.classList.add('active');
                            setTimeout(() => {
                                errorElement.classList.remove('active');
                                errorElement.textContent = `è«‹è¼¸å…¥${denomination}çš„å€æ•¸`; // æ¢å¾©åŸå§‹æç¤º
                            }, 2000);
                        }
                    }
                });
            });

            // è¢‹/æ†è¼¸å…¥æ¡† (åªå…è¨±æ•¸å­—)
            Object.values(bagInputs).forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^\d]/g, '');
                });
            });

            // æ¨¡æ…‹æ¡†é–‹é—œ
            showPackageBtn.onclick = () => packageModal.style.display = "block";
            showManualBtn.onclick = () => manualModal.style.display = "block";
            showExchangeBtn.onclick = () => {
                initExchangeModal(); // åˆå§‹åŒ–é¢é¡æ›ç®—æ¨¡æ…‹æ¡†
                exchangeModal.style.display = "block";
            };

            closeBtns.forEach(btn => {
                btn.onclick = () => {
                    packageModal.style.display = "none";
                    manualModal.style.display = "none";
                    exchangeModal.style.display = "none";
                };
            });

            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            window.onclick = (event) => {
                if (event.target === packageModal) packageModal.style.display = "none";
                if (event.target === manualModal) manualModal.style.display = "none";
                if (event.target === exchangeModal) exchangeModal.style.display = "none";
            };

            // é¢é¡æ›ç®—æ¨¡æ…‹æ¡†äº‹ä»¶
            exchangeAmountInput.addEventListener('input', () => {
                formatInputWithCommas(exchangeAmountInput); // å³æ™‚æ ¼å¼åŒ–
                updateExchangeInfo(); // æ›´æ–°é è¦½
            });
            exchangeFromSelect.addEventListener('change', updateExchangeInfo);
            exchangeToSelect.addEventListener('change', updateExchangeInfo);
            exchangeConfirmBtn.addEventListener('click', performExchange); // ç¢ºèªè½‰æ›

        });
    </script>
</body>
</html>
